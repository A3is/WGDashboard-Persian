<!-- Persianized and developed by A3is in Opiran - [https://github.com/opiran-club] -->
<!doctype html>
<html lang="fa" dir="rtl">
{% with title=title%}
    {% include "header.html"%}
{% endwith %}
<body>
    <div class="no-response">
        <div class="container">
            <h1 class="text-white display-1"><i class="bi bi-emoji-frown-fill"></i></h1>
            <h4 class="text-white">اووه!<br>اتصال به سرور با خطا مواجه شد ;(</h4>
        </div>
    </div>
	{% include "navbar.html" %}
	<div class="container-fluid" id="right_body">
		{% include "sidebar.html" %}
		<div id="config_body">
            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-md-4 mt-4">
                <div class="info mt-4">
                    <div id="config_info_alert"></div>
                    <div class="row">
                        <div class="col">
                            <small class="text-muted"><strong>کانفیگ</strong></small>
                            <h1 class="mb-3"><samp id="conf_name">{{ title }}</samp></h1>
                        </div>
                        <div class="col">
                            <small class="text-muted"><strong>خاموش / روشن</strong></small><br>
                            <div id="conf_status_btn" class="info_loading"></div>
                            <div class="spinner-border text-primary" role="status" style="display: none; margin-top: 10px">
                                <span class="sr-only"></span>
                            </div>
                        </div>

                        <hr>
                        <br style="clear: both;">



                        <div class="container">

                            <div class="row" style="text-align: right;">
                                <div class="col-sm-6 mt-2">

                                    <div class="col">
                                        <small class="text-muted"><strong>وضعیت :</strong></small>
                                        <h6 style="text-transform: uppercase; direction: ltr;" id="conf_status" class="info_loading"></h6>
                                    </div>
                                    <div class="col">
                                        <small class="text-muted"><strong>کل مقدار دیتای مصرفی :</strong></small>
                                        <h6 style="text-transform: uppercase; direction: ltr" id="conf_total_data_usage" class="info_loading"></h6>
                                    </div>
                                    <div class="col">
                                        <small class="text-muted"><strong>مقدار دریافت شده :</strong></small>
                                        <h6 style="text-transform: uppercase; direction: ltr" id="conf_total_data_received" class="info_loading"></h6>
                                    </div>
                                    <div class="col-sm">
                                        <small class="text-muted"><strong>مقدار ارسال شده :</strong></small>
                                        <h6 style="text-transform: uppercase; direction: ltr" id="conf_total_data_sent" class="info_loading"></h6>
                                    </div>

                                </div>
                                <div class="col-sm-6 mt-2">
    
                                    <div class="col">
                                        <small class="text-muted"><strong>کاربران متصل :</strong></small>
                                        <h6 style="text-transform: uppercase;" id="conf_connected_peers" class="info_loading"></h6>
                                    </div>
                                    <div class="col-sm">
                                        <small class="text-muted"><strong>پورت وایرگارد :</strong></small>
                                        <h6 style="text-transform: uppercase;" class="info_loading"><samp id="conf_listen_port"></samp></h6>
                                    </div>
                                     <div class="col-sm">
                                        <small class="text-muted"><strong>آدرس :</strong></small>
                                        <h6 style="text-transform: uppercase;" class="info_loading"><samp id="conf_address"></samp></h6>
                                    </div>
                                    <div class="col-sm">
                                        <small class="text-muted">
                                            <strong>کلید عمومی :</strong>
                                            <strong style="margin-left: auto!important; opacity: 0; transition: 0.2s ease-in-out" class="text-primary">جهت کپی کردن کلید کنید</strong>
                                        </small>
                                        <h6 class="info_loading"><samp class="key public_key_mobile" id="conf_public_key"></samp></h6>
                                    </div>
    
                                </div>
                            </div>
                        </div>

                        
                    </div>
                </div>
                <hr>
                <div class="button-div mb-3">
                    <div class="row">
                        <div class="col-sm">
                             <div class="form-group">
                                <label for="sort_by_dropdown"><small class="text-muted">مرتب کردن کاربران بر اساس</small></label>
                                <select class="form-control" id="sort_by_dropdown">
                                    <option value="status">وضعیت</option>
                                    <option value="name">نام</option>
                                    <option value="allowed_ip">آی پی داده شده</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm">
                            <div class="form-group">
                                <label><small class="text-muted">بروز رسانی زمانی</small></label><br>
                                <div class="btn-group interval-btn-group" role="group" style="width: 100%">
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary btn-group-label refresh" data-toggle="tooltip" data-placement="bottom" title="بروزرسانی کاربران"><i class="bi bi-arrow-repeat"></i></button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="5000">5s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="10000">10s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="30000">30s</button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary update_interval" data-refresh-interval="60000">1m</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm display_mode_mobile">
                            <div class="form-group">
                                <label><small class="text-muted">حالت نمایشی</small></label><br>
                                <div class="btn-group display-btn-group" role="group" style="width: 100%">
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary display_mode" data-display-mode="grid"><i class="bi bi-grid-fill" style="font-size: 1rem;"></i></button>
                                    <button style="width: 20%" type="button" class="btn btn-outline-primary display_mode" data-display-mode="list"><i class="bi bi-list" style="font-size: 1rem;"></i></button>
                                </div>
                            </div>
                        </div>


                        


                        <div class="btn-manage-group">
                            
                            <button type="button" class="btn btn-secondary setting_btn"><i class="bi bi-three-dots"></i></button>
                            <button type="button" class="btn btn-primary add_btn"><i class="bi bi-plus-circle-fill" style=""></i></button>
                            <div class="setting_btn_menu">
                                <a class="text-danger" id="delete_peers_by_bulk_btn"><i class="bi bi-trash-fill"></i>حذف کاربران</a>
                                <a class="text-info" id="download_all_peers" data-url="/download_all/{{conf_data['name']}}"><i class="bi bi-cloud-download-fill"></i>دانلود کاربران</a>
                            </div>
                        </div>

                        <hr class="mt-4">

                        <br style="clear: both;">
                        <div class="col-md-12  col-12 mt-4 mb-4" style="float: left;">
                            <div class="form-group">
                                <input type="text" class="form-control" id="search_peer_textbox" placeholder="...جستجو کاربر" value="" dir="ltr">
                            </div>
                        </div>
                        <br style="clear: both;">


                        

                    </div>

                    
                </div>
                <div class="row peer_list"></div>
                <small id="peer_loading_time" class="text-muted"></small>
            </main>
        </div>
	</div>

	<div class="modal fade" id="add_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">اضافه کردن کاربر جدید</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
                    <div class="d-none">
                        <div class="custom-control custom-switch" style="margin-bottom: 1rem">
                            <input class="custom-control-input" type="checkbox" id="bulk_add">
                            <label class="custom-control-label" for="bulk_add"><strong>اضافه کردن کاربر دسته جمعی</strong></label>
                            <i class="bi bi-question-circle-fill" style="cursor: pointer" data-container="body" data-toggle="popover" data-placement="right" data-trigger="click" data-content="با  فعال کردن این گزینه، نام و ای پی کانفیگ به صورت خودکار قرار خواهد گرفت."></i>
                        </div>
                        <div class="form-group" style="margin: 0">
                            <input type="number" class="form-control" id="new_add_amount" min="1" placeholder="Amount" disabled>
                            <div id="bulk_amount_validation" class="invalid-feedback"></div>
                        </div>

                    </div>
                    <hr class="d-none">
					<div id="add_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form id="add_peer_form">
                        <div class="form-group non-bulk">
                            <div>
                                <label for="private_key">کلید خصوصی :</label>
                            </div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="private_key" aria-describedby="private_key" dir="ltr">
                                <div class="input-group-append">
                                   <button type="button" class="btn btn-danger" id="re_generate_key" data-toggle="tooltip" data-placement="top" title="Regenerate Key"><i class="bi bi-arrow-repeat"></i></button>
                                </div>
                            </div>
                        </div>
						<div class="form-group non-bulk">
							<label for="public_key">کلید عمومی :<a class="text-danger">(الزامی)</a></label>
							<input type="text" class="form-control" id="public_key" aria-describedby="public_key" disabled  dir="ltr">
						</div>
                        <div class="row">
                            <div class="col-sm-6 non-bulk">
                                 <div class="form-group">
                                    <label for="new_add_name">نام :</label>
                                    <input type="text" class="form-control" id="new_add_name" value="{{ title }}" dir="ltr">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="form-group">
                                    <label for="peer_date_input"> زمان اشتراک : <a class="text-danger">(الزامی)</a></label>
                                    <input type="text" class="form-control peer_date_input" name="peer_date_input" id="peer_date_input" value="" autocomplete="off" placeholder="زمان اشتراک" required readonly style="background:#fff;"  dir="rtl">
                                    <div style="width: 0;height: 0; overflow: hidden;"><input type="text" class="form-control peer_date" name="peer_date" id="peer_date" dir="ltr" value=""></div>
                                </div> 
                           </div>
                           <div class="col-sm-6">
                                <div class="form-group">
                                   <label for="new_peer_traffic"> حجم (گیگابایت) : <a class="text-danger">(الزامی)</a></label>
                                   <input type="number" class="form-control" id="new_peer_traffic" value="{{ peer_traffic }}"  dir="ltr" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                               </div>
                           </div>
                            <div class="col-sm-6 non-bulk">
                                <div class="form-group">
                                    <label for="allowed_ips">آی پی وایرگارد کاربر : <a class="text-danger">(الزامی)</a></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="allowed_ips"  dir="ltr">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-primary" id="search_available_ip" data-toggle="tooltip" data-placement="top" title="جستجو آیپی های فعال">
                                                <i class="bi bi-search"></i>
                                            </button>
                                        </div> 
                                    </div>
                                    <p style="position: absolute; top: 4px; right: 1rem;" class="text-success" id="allowed_ips_indicator"></p>
                                </div>
                            </div>
                            
                           
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_DNS">DNS : <a class="text-danger">(الزامی)</a></label>
                                    <input type="text" class="form-control" id="new_add_DNS" value="{{ DNS }}"  dir="ltr">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_endpoint_allowed_ip">Endpoint Allowed IPs : <a class="text-danger">(الزامی)</a></label>
                                    <input type="text" class="form-control" id="new_add_endpoint_allowed_ip" value="{{ endpoint_allowed_ip }}"  dir="ltr">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_MTU">MTU :</label>
                                    <input type="text" class="form-control" id="new_add_MTU" value="{{ mtu }}"  dir="ltr">
                                </div>
                            </div>
                            <div class="col-sm-6">
                                 <div class="form-group">
                                    <label for="new_add_keep_alive"> keepalive :</label>
                                    <input type="text" class="form-control" id="new_add_keep_alive" value="{{ keep_alive }}"  dir="ltr">
                                 </div>
                            </div>
                            <div class="col-sm">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable_preshare_key" name="enable_preshare_key" value="enable_psk">
                                    <label class="form-check-label" for="enable_preshare_key"> Pre-shared Key</label>
                                </div>
                            </div>
                        </div>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="save_peer" conf_id={{conf_data['name']}}>اضافه کردن</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">لغو</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="delete_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">آیا از حذف این کاربر مطمین هستید ؟</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div id="remove_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
					<h6 style="margin: 0">این کار برگشت پذیر نیست.</h6>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" id="delete_peer" conf_id={{conf_data['name']}} peer_id="">بله</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">خیر</button>
				</div>
			</div>
		</div>
	</div>
    <div class="modal fade" id="setting_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true" conf_id={{conf_data['name']}} peer_id="">
		<div class="modal-dialog modal-dialog-centered modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title peer_name"></h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
                    <div id="setting_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
						<button type="button" class="close" data-dismiss="alert" aria-label="Close">
						  <span aria-hidden="true">&times;</span>
						</button>
					</div>
                    <div class="mb-3">
                        <label for="peer_private_key_textbox" class="form-label">کلید خصوصی :</label>
                        <input type="password" class="form-control" id="peer_private_key_textbox" style="padding-right: 40px" dir="ltr">
                        <a class="peer_private_key_textbox_switch"><i class="bi bi-eye-fill"></i></a>
                    </div>
                    <div>
                        <label for="peer_preshared_key_textbox" class="form-label">Pre-Shared Key :</label>
                        <input type="text" class="form-control" id="peer_preshared_key_textbox" dir="ltr">
                    </div>
                    <hr>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_name_textbox" class="form-label">نام :</label>
                              <input type="text" class="form-control" id="peer_name_textbox" placeholder="" dir="ltr">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="peer_date_input"> زمان اشتراک : <code>(Required)</code></label>
                                <input type="text" class="form-control peer_date_input" name="peer_date_input" id="peer_date_input" value="{{ peer_date }}" autocomplete="off" placeholder="زمان اشتراک" required readonly style="background:#fff;"  dir="rtl">
                                <div style="width: 0;height: 0; overflow: hidden;"><input type="text" class="form-control peer_date" value="{{ peer_date }}" name="peer_date" id="peer_date" dir="ltr"></div>
                            </div> 
                       </div>
                       <div class="col-sm-6">
                            <div class="form-group">
                               <label for="new_peer_traffic"> حجم (گیگابایت) : <code>(Required)</code></label>
                               <input type="number" class="form-control" id="new_peer_traffic" value="{{ peer_traffic }}"  dir="ltr" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                           </div>
                       </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_allowed_ip_textbox" class="form-label">Allowed IPs <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_allowed_ip_textbox" dir="ltr">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_DNS_textbox" class="form-label">DNS <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_DNS_textbox" dir="ltr">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_endpoint_allowed_ips" class="form-label">Endpoint Allowed IPs <code>(Required)</code></label>
                              <input type="text" class="form-control" id="peer_endpoint_allowed_ips" dir="ltr">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_mtu" class="form-label">MTU</label>
                              <input type="text" class="form-control" id="peer_mtu" dir="ltr">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="mb-3">
                              <label for="peer_keep_alive" class="form-label">Persistent Keepalive</label>
                              <input type="text" class="form-control" id="peer_keep_alive" dir="ltr">
                            </div>
                        </div>
                    </div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" id="save_peer_setting" conf_id={{conf_data['name']}} peer_id="">ذخیره</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">لغو</button>
				</div>
			</div>
		</div>
	</div>
    <div class="modal fade" id="available_ip_modal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">انتخاب آیپی فعال</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
                <div class="selected_ip" style="padding: 1rem; border-bottom: 1px solid #dee2e6;">
                        <small class="text-muted"><strong>IP انتخاب شده (برای حذف کلیک کنید)</strong></small>
                        <div id="selected_ip_list"></div>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: scroll;">
                    <div class="list-group"></div>
                </div>
                <div class="modal-footer">
					<button type="button" class="btn btn-primary" id="confirm_ip">تایید</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">لغو</button>
				</div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="delete_bulk_modal" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
					<h5 class="modal-title" id="staticBackdropLabel">کاربر را برای حذف انتخاب کنید</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
                <div id="bulk_remove_peer_alert" class="alert alert-danger alert-dismissible fade show d-none" role="alert" style="margin: 1rem">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="selected_peers" style="padding: 1rem; border-bottom: 1px solid #dee2e6;">
                        <small class="text-muted"><strong>کاربر انتخاب شده (برای حذف کلیک کنید)</strong></small>
                        <div id="selected_peer_list"></div>
                </div>
                <div class="modal-body" style="max-height: 400px; overflow-y: scroll;">
                    <div class="list-group"></div>
                </div>
                <div class="modal-footer">
                    <a class="text-danger" id="select_all_delete_bulk_peers" style="cursor: pointer; margin-right: auto;"><small><strong>انتخاب همه</strong></small></a>
					<button type="button" class="btn btn-danger" id="confirm_delete_bulk_peers" disabled data-conf="{{conf_data['name']}}">حذف</button>
				</div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="qrcode_modal" data-backdrop="static" data-keyboard="false" tabindex="-1"
		aria-labelledby="staticBackdropLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">QR Code</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
                    <img id="qrcode_img" style="width: 100%">
				</div>
			</div>
		</div>
	</div>
    <div class="position-fixed top-2 left-0 p-3" style="z-index: 5; left: 0; top: 70px;">
          <div id="alertToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true" data-delay="5000">
            <div class="toast-header">
                  <strong class="mr-auto"></strong>
                  <button type="button" class="mr-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
            </div>
            <div class="toast-body">
            </div>
          </div>
    </div>
    {% include "tools.html" %}
</body>
{% include "footer.html" %}
<script src="{{ url_for('static',filename='js/wireguard.min.js') }}"></script>
<script src="{{ url_for('static',filename='js/configuration.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static',filename='css/persian-datepicker.css') }}"/>
<script src="{{ url_for('static',filename='js/persian-date.js') }}"></script>
<script src="{{ url_for('static',filename='js/persian-datepicker.js') }}"></script>
<script>
    /* global peers */
    let load_timeout;
    let load_interval = 0;
    let conf_name = "{{ conf_data['name'] }}"
    let peers = [];
    $(".sb-"+conf_name+"-url").addClass("active");
	$(function(){
		configurations.loadPeers($('#search_peer_textbox').val());
	});


    $(document).ready(function(){  
        $('.peer_date_input').persianDatepicker({
            initialValue: false,
            format: 'LLLL',
            altField: '.peer_date',
            altFormat: 'lll',
            autoClose: true,
            "timePicker": {
                    "enabled": true,
                    "step": 1,
                    "hour": {
                    "enabled": true,
                    "step": null
                    },
                    "minute": {
                    "enabled": true,
                    "step": null
                    },
                    "second": {
                    "enabled": false,
                    "step": null
                    },
                    "meridian": {
                    "enabled": true
                    }
                }//
        });//
    });//
</script>
</html>	
